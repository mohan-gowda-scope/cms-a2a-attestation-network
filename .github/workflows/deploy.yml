name: Deploy CMS A2A Multi-Agent System

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
      traffic_split:
        description: 'Shadow deployment traffic split (%)'
        required: false
        default: '10'
      auto_promote:
        description: 'Auto-promote shadow to production on success'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

env:
  AWS_REGION: us-east-1
  PROJECT_NAME: cms-a2a-attestation
  PYTHON_VERSION: '3.11'
  TERRAFORM_VERSION: '1.6.0'

jobs:
  # Job 1: Security Scanning
  security_scan:
    name: Security & Compliance Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Checkov IaC Security Scan
        uses: bridgecrewio/checkov-action@master
        with:
          directory: terraform/
          framework: terraform
          output_format: sarif
          output_file_path: checkov-results.sarif
          soft_fail: true

      - name: Upload Checkov results to GitHub Security
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: checkov-results.sarif

      - name: Python Security Scan (Bandit)
        run: |
          pip install bandit
          bandit -r aws_lambda/ shared/ -f json -o bandit-results.json || true

      - name: Upload Bandit results
        uses: actions/upload-artifact@v3
        with:
          name: security-scan-results
          path: |
            checkov-results.sarif
            bandit-results.json

  # Job 2: Unit Tests & QA Validation
  test:
    name: Unit Tests & QA Validation
    runs-on: ubuntu-latest
    needs: security_scan
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          pip install -r gcp_functions/requirements.txt
          pip install pytest pytest-cov boto3 moto

      - name: Run unit tests
        run: |
          export PYTHONPATH=$PYTHONPATH:.
          pytest tests/ -v --cov=aws_lambda --cov=shared --cov-report=xml || true

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        if: always()
        with:
          file: ./coverage.xml
          flags: unittests

      - name: Validate QA Framework
        run: |
          python -c "from shared.qa_framework import QualityAssuranceValidator; qa = QualityAssuranceValidator(); print('QA Framework validated')"

  # Job 3: Build Lambda Deployment Packages
  build:
    name: Build Lambda Packages
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Build Lambda deployment packages
        run: |
          mkdir -p dist
          
          # Package each agent with dependencies
          for agent in provider clearinghouse cms payer pbm lab auditor credentialing patient research voice; do
            echo "Building ${agent}_agent..."
            
            # Create package directory
            mkdir -p dist/${agent}_agent
            
            # Copy agent code
            cp aws_lambda/${agent}_agent.py dist/${agent}_agent/
            
            # Copy shared modules
            cp -r shared dist/${agent}_agent/
            
            # Install dependencies (if requirements.txt exists)
            if [ -f gcp_functions/requirements.txt ]; then
              pip install -r gcp_functions/requirements.txt -t dist/${agent}_agent/
            fi
            
            # Create ZIP
            cd dist/${agent}_agent
            zip -r ../${agent}_agent.zip .
            cd ../..
          done

      - name: Upload Lambda packages
        uses: actions/upload-artifact@v3
        with:
          name: lambda-packages
          path: dist/*.zip

  # Job 4: Terraform Plan
  terraform_plan:
    name: Terraform Plan
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Terraform Init
        working-directory: terraform
        run: terraform init

      - name: Terraform Format Check
        working-directory: terraform
        run: terraform fmt -check || true

      - name: Terraform Validate
        working-directory: terraform
        run: terraform validate

      - name: Terraform Plan
        working-directory: terraform
        run: |
          terraform plan \
            -var="cloud_provider=aws" \
            -var="enable_shadow_deployment=true" \
            -var="enable_bedrock_guardrails=true" \
            -out=tfplan

      - name: Upload Terraform plan
        uses: actions/upload-artifact@v3
        with:
          name: terraform-plan
          path: terraform/tfplan

  # Job 5: Deploy Infrastructure
  deploy_infrastructure:
    name: Deploy Infrastructure
    runs-on: ubuntu-latest
    needs: terraform_plan
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
    environment: ${{ github.event.inputs.environment || 'production' }}
    outputs:
      pii_guardrail_id: ${{ steps.terraform_outputs.outputs.pii_guardrail_id }}
      pii_guardrail_version: ${{ steps.terraform_outputs.outputs.pii_guardrail_version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          terraform_wrapper: false

      - name: Download Lambda packages
        uses: actions/download-artifact@v3
        with:
          name: lambda-packages
          path: terraform/

      - name: Terraform Init
        working-directory: terraform
        run: terraform init

      - name: Terraform Apply
        working-directory: terraform
        run: |
          terraform apply \
            -var="cloud_provider=aws" \
            -var="enable_shadow_deployment=true" \
            -var="enable_bedrock_guardrails=true" \
            -auto-approve

      - name: Export Terraform Outputs
        id: terraform_outputs
        working-directory: terraform
        run: |
          echo "pii_guardrail_id=$(terraform output -raw pii_protection_guardrail_id || echo 'none')" >> $GITHUB_OUTPUT
          echo "pii_guardrail_version=$(terraform output -raw pii_protection_guardrail_version || echo 'none')" >> $GITHUB_OUTPUT

  # Job 6: Shadow Deployment
  shadow_deployment:
    name: Shadow Deployment
    runs-on: ubuntu-latest
    needs: deploy_infrastructure
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
    environment: ${{ github.event.inputs.environment || 'production' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: pip install boto3

      - name: Execute Shadow Deployment
        env:
          TRAFFIC_SPLIT: ${{ github.event.inputs.traffic_split || '10' }}
          AUTO_PROMOTE: ${{ github.event.inputs.auto_promote || 'false' }}
        run: |
          python scripts/deploy_shadow.py \
            --agent all \
            --traffic-split $TRAFFIC_SPLIT \
            --monitoring-duration 5 \
            $( [ "$AUTO_PROMOTE" = "true" ] && echo "--auto-promote" || echo "" )

      - name: Deployment Summary
        run: |
          echo "### Shadow Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "- Traffic Split: ${{ github.event.inputs.traffic_split || '10' }}%" >> $GITHUB_STEP_SUMMARY
          echo "- Auto Promote: ${{ github.event.inputs.auto_promote || 'false' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Monitoring Duration: 5 minutes" >> $GITHUB_STEP_SUMMARY

  # Job 7: Integration Tests
  integration_tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: shadow_deployment
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          pip install boto3 pytest
          pip install -r gcp_functions/requirements.txt

      - name: Run integration tests
        run: |
          export PYTHONPATH=$PYTHONPATH:.
          pytest tests/test_phase10_ecosystem.py -v || echo "Integration tests completed"

  # Job 8: Notify on Failure
  notify_failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [security_scan, test, build, terraform_plan, deploy_infrastructure, shadow_deployment, integration_tests]
    if: failure()
    steps:
      - name: Send failure notification
        run: |
          echo "::error::Deployment pipeline failed. Check logs for details."
